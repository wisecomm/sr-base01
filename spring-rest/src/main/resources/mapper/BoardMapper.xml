<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.springrest.domain.boards.board.repository.BoardMapper">
    <resultMap id="BoardResultMap" type="com.example.springrest.domain.boards.board.model.entity.Board">
        <id property="boardId" column="BOARD_ID"/>
        <result property="brdId" column="BRD_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="title" column="TITLE"/>
        <result property="contents" column="CONTENTS"/>
        <result property="hitCnt" column="HIT_CNT"/>

        <result property="secretYn" column="SECRET_YN"/>
        <result property="useYn" column="USE_YN"/>
        <result property="sysInsertDtm" column="SYS_INSERT_DTM"/>
        <result property="sysInsertUserId" column="SYS_INSERT_USER_ID"/>
        <result property="sysUpdateDtm" column="SYS_UPDATE_DTM"/>
        <result property="sysUpdateUserId" column="SYS_UPDATE_USER_ID"/>
    </resultMap>

    <sql id="BoardColumns">
        BOARD_ID, BRD_ID, USER_ID, TITLE, CONTENTS, HIT_CNT, SECRET_YN, USE_YN,
        SYS_INSERT_DTM, SYS_INSERT_USER_ID, SYS_UPDATE_DTM, SYS_UPDATE_USER_ID
    </sql>

    <select id="findById" resultMap="BoardResultMap">
        SELECT <include refid="BoardColumns"/>
        FROM CHMM_BOARD
        WHERE BOARD_ID = #{boardId}
    </select>

    <select id="findAll" resultMap="BoardResultMap">
        SELECT <include refid="BoardColumns"/>
        FROM CHMM_BOARD
        <where>
            BRD_ID = #{brdId}
            AND USE_YN = '1'
            <if test="searchType == 'title' and keyword != null and keyword != ''">
                AND TITLE LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType == 'contents' and keyword != null and keyword != ''">
                AND CONTENTS LIKE CONCAT('%', #{keyword}, '%')
            </if>
             <if test="searchType == 'userId' and keyword != null and keyword != ''">
                AND USER_ID LIKE CONCAT('%', #{keyword}, '%')
            </if>
             <if test="(searchType == null or searchType == '') and keyword != null and keyword != ''">
                AND (TITLE LIKE CONCAT('%', #{keyword}, '%') OR CONTENTS LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="startDate != null and startDate != ''">
                AND SYS_INSERT_DTM &gt;= #{startDate}::timestamp
            </if>
            <if test="endDate != null and endDate != ''">
                AND SYS_INSERT_DTM &lt;= #{endDate}::timestamp
            </if>
        </where>
        ORDER BY BOARD_ID DESC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO CHMM_BOARD (
            BRD_ID, USER_ID, TITLE, CONTENTS, HIT_CNT, SECRET_YN, USE_YN,
            SYS_INSERT_DTM, SYS_INSERT_USER_ID, SYS_UPDATE_DTM, SYS_UPDATE_USER_ID
        ) VALUES (
            #{brdId}, #{sysInsertUserId}, #{title}, #{contents}, 0, #{secretYn}, '1',
            NOW(), #{sysInsertUserId}, NOW(), #{sysUpdateUserId}
        )
    </insert>

    <update id="update">
        UPDATE CHMM_BOARD
        SET TITLE = #{title},
            CONTENTS = #{contents},

            SECRET_YN = #{secretYn},
            USE_YN = #{useYn},
            SYS_UPDATE_DTM = NOW(),
            SYS_UPDATE_USER_ID = #{sysUpdateUserId}
        WHERE BOARD_ID = #{boardId}
    </update>

    <delete id="delete">
        UPDATE CHMM_BOARD
        SET USE_YN = '0',
            SYS_UPDATE_DTM = NOW()
        WHERE BOARD_ID = #{boardId}
    </delete>
</mapper>
